---
title: "ProblemSet2_new"
author: "Ke-li Chiu & Diego Mamanche Castellanos"
date: "06/02/2020"
output: pdf_document
abstract: "Education is a contributor to many beneficial socio-economic outcomes. We intend to exam the education profile in the selected neighbourhoods of Toronto that have polarized household income from the data set package *Wellbeing Toronto - Demographics: NHS Indicators*. We first observe that the income gap between the neighbourhood with the highest household income and the lowest is enormous. The median household income of Bridle Path-Sunnybrook-York Mills is almost nine times more than Regent Park before tax. Bridle Path-Sunnybrook-York Mills also has a much higher attainment rate (45%) of higher education above a bachelor's degree than Regent Park (23%) and the City of Toronto (27%). We intend to use the comparison to bring awareness of inequality in income and education existing in the City of Toronto."
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE, include=FALSE, message=FALSE}
#Set up the environment
library(opendatatoronto)
library(dplyr)
library(tidyr)
library(tidyverse)
library(ggplot2)
library(knitr)
library(data.table) #Useful to transponse a dataframe
library(sf)
library(tmap)
library(tmaptools)
library(leaflet)

```

# Introduction
Education is a contributor to many beneficial socio-economic outcomes. In the previous study where we examined the educational profile of Toronto’s neighbourhoods, we found that the neighbourhood with the highest median household income has a much higher attainment rate (45%) of higher education above a bachelor’s degree than the compared with the lowest (23%) and the City of Toronto (27%). In this study, we extend the examination of educational profile to the residents’ academic majors in the following categories—
"visual and performing arts and communications technologies", "humanities", "social and behavioural sciences and law”,  "business_management_and_public_administration", "physical and life sciences and technologies", "mathematics computer and information sciences", "architecture engineering and related technologies", "agriculture natural resources and conservation", "personal protective and transportation services" and "no postsecondary certificate diploma or degree”. The question we want to answer is [the question]. [Broader context: education as social mobility]

```{r echo=FALSE, include=FALSE, message=FALSE}
#Set working Directory
#setwd("~/Experimental Design for Data Science/ProblemSet2")

# Search packages (this returns a table)
neighbourhood_packages <- search_packages("Neighbourhood")
# Filter the neighbourhood demographic dataset
neighbourhood_demographics_package<- neighbourhood_packages %>%
  filter(title == "Neighbourhood Profiles")

#Create main dataset for year 2011 
main_df_2011 <-  neighbourhood_demographics_package %>% # Start with the package 
  list_package_resources() %>% # List the resources in the package
  filter(name == "Neighbourhood Data 2001, 2006, 2011.xlsx") %>% # Only keep the resource we want 
  get_resource()

### GEO-LOCATION DATASET TORONTO BY NEIGHBOURHOODS ###

# get package
package <- show_package("4def3f65-2a65-4a4f-83c4-b2a4aed72d46")
package

# get all resources for this package
resources <- list_package_resources("4def3f65-2a65-4a4f-83c4-b2a4aed72d46")

# identify datastore resources; by default, Toronto Open Data sets datastore resource format to CSV for non-geospatial and GeoJSON for geospatial resources
datastore_resources <- filter(resources, tolower(format) %in% c('csv', 'geojson'))

# load the first datastore resource as a sample
geo_data <- filter(datastore_resources, row_number()==1) %>% get_resource()

```

# Dataset and method descriptiion
City of Toronto Neighbourhood Profiles dataet is sourced from a number of Census tables released by Statistics Canada every five years. The dataset uses this Census data to provide a portrait of the demographic, social and economic characteristics of the people and households in each City of Toronto neighbourhood. Each data point in this file is presented for the City's 140 neighbourhoods, as well as for the City of Toronto as a whole. 

Exploratory data analysis is conducted to obtain insight from the dataset. The variables we are interested in are median total household income and the academic fields the residents major or majored in. We would like to see if certain academic majors are more common or least common in different neighbourdhoods distinced by income. [Methods: map, lm, comparison...]


## Limitation of the dataset and approach
Although there are datasets for 2001,2006, 2011 and 2016, the structure and available information of the datasets are inconsistent. For example, median total household income for all neighbourhood is only available in the dataset from 2011, therefore this study is limited to the year of 2011 and is unable to provide comparison between Census years regarding the changes in income and education profile of the neighbourhoods.

## Ethical considerations
By revealing the [...]
Stereotypes 
Discriminations 
Transportation
Ranking of academic fields by the associated, 

```{r echo=FALSE, include=FALSE, message=FALSE}
##### Distribution by education 2011####
#Select sheet 2011
clean_header_df_2011 <- main_df_2011$`2011`
#Clean header using janitor
clean_header_df_2011 <- janitor::clean_names(clean_header_df_2011)
#Select only Education by major from the main dataset 
education_df_2011 <- filter(clean_header_df_2011, category == "Education" & topic == "Major field of study - Classification of Instructional Programs (CIP)")
# Remove row with the totals 
education_df_2011 <-
  education_df_2011 %>% 
    filter(!str_detect(attribute, "Total"))
#Remove first two columns 
education_df_2011 <- education_df_2011[,3:length(education_df_2011)]
#Change class of columns containing numbers as.numeric 
education_df_2011[,2:length(education_df_2011)] <- sapply(education_df_2011[,2:length(education_df_2011)], function(x) as.numeric(x))
```
```{r echo=FALSE, include=FALSE, message=FALSE}
#Create new dataframe
scaled_education_df_2011 <- education_df_2011
#Scale dataframe by column
scaled_education_df_2011 <-
  scaled_education_df_2011 %>%
    janitor::adorn_percentages(denominator = "col")


#Multiply by 100
scaled_education_df_2011[,2:length(education_df_2011)] <- sapply(scaled_education_df_2011[,2:length(scaled_education_df_2011)], function(x) (x*100))

#Round new sclaes to 3 digits
scaled_education_df_2011 <-
  scaled_education_df_2011 %>%
    janitor::adorn_rounding(digits = 2)

#Transform the result to dataframe
scaled_education_df_2011 <- as.data.frame(scaled_education_df_2011)
```
```{r echo=FALSE, include=FALSE, message=FALSE}
#Save neighbourhoods into a dataframe
col_names_2011 <- as.data.frame(colnames(scaled_education_df_2011))
col_names_2011 <- col_names_2011[2:nrow(col_names_2011),]
col_names_2011 <- as.data.frame(col_names_2011)
colnames(col_names_2011) <- "neighbourhoods"
col_names_2011
#Reshape dataframe
edu_df_2011_reshaped <- transpose(scaled_education_df_2011, make.names=1)
#Include neighbourhoods column
edu_df_2011_reshaped <- mutate(edu_df_2011_reshaped, neighbourhoods = col_names_2011$neighbourhoods)
#Clean header names
edu_df_2011_reshaped <- janitor::clean_names(edu_df_2011_reshaped)
#Reorder columns
edu_df_2011_reshaped <- select(edu_df_2011_reshaped, neighbourhoods, no_postsecondary_certificate_diploma_or_degree:other_fields_of_study)
```


```{r echo=FALSE, include=FALSE, message=FALSE}
##### Distribution by income 2011####
#Select sheet 2011
clean_income_df_2011 <- main_df_2011$`2011`
#Clean header using janitor
clean_income_df_2011 <- janitor::clean_names(clean_income_df_2011)
#Select only median income from the main dataset 
income_df_2011 <- clean_income_df_2011[756,]
#Remove first two columns 
income_df_2011 <- income_df_2011[,3:length(income_df_2011)]
#Change class of columns containing numbers as.numeric 
income_df_2011[,2:length(income_df_2011)] <- sapply(income_df_2011[,2:length(income_df_2011)], function(x) as.numeric(x))
```
```{r echo=FALSE, include=FALSE, message=FALSE}
#Create new dataframe
col_names_2011_income  <- as.data.frame(colnames(income_df_2011))
#Save neighbourhoods into a dataframe
col_names_2011_income <- col_names_2011_income[2:nrow(col_names_2011_income),]
col_names_2011_income <- as.data.frame(col_names_2011_income)
colnames(col_names_2011_income) <- "neighbourhoods"
#Reshape dataframe
inco_df_2011_reshaped <- transpose(income_df_2011, make.names=1)
#Include neighbourhoods column
inco_df_2011_reshaped <- mutate(inco_df_2011_reshaped, neighbourhoods = col_names_2011_income$neighbourhoods)
#Clean header names
inco_df_2011_reshaped <- janitor::clean_names(inco_df_2011_reshaped)
#Reorder columns
inco_df_2011_reshaped <- select(inco_df_2011_reshaped, neighbourhoods, median_household_total_income)
```
```{r}
### Cleaning geo-location dataset
clean_geo_data <- janitor::clean_names(geo_data)

clean_geo_data <- extract(clean_geo_data, area_name, into = "neighbourhoods" , regex = "([^(0-9)]+)")


clean_geo_data["neighbourhoods"] <- 
  janitor::make_clean_names(as.matrix(clean_geo_data["neighbourhoods"]))

clean_geo_data <- janitor::clean_names(clean_geo_data)

clean_geo_data <- select(clean_geo_data, neighbourhoods, longitude, latitude, geometry)


filter(clean_geo_data, neighbourhoods %in% c("mimico","weston_pellam_park"))

clean_geo_data["neighbourhoods"][c(17,67),] <- c("mimico_includes_humber_bay_shores","weston_pelham_park")

clean_geo_data

```
# Income and Education by Major 2011


```{r echo=FALSE, include=FALSE, message=FALSE}
#Merge income and education 2011
merged_df <- merge(edu_df_2011_reshaped, inco_df_2011_reshaped, by = 'neighbourhoods')
merged_df <- merge(merged_df, clean_geo_data, by = 'neighbourhoods', all.x = TRUE)

#Create a sf version
sf_merged_df <- st_sf(merged_df, sf_column_name = "geometry")
colnames(sf_merged_df) <- c("neighbourhoods" ,
"no_certificate" ,
"education" ,
"arts_&_com",
"humanities" ,
"social_&_law" ,
"business" ,
"physical_&_life" ,
"mathematics_&_it" ,
"architecture_engin" ,
"agriculture" ,
"health" ,
"transportation" ,
"other" ,
"median_income",
"longitude",                                                 
"latitude",                                                                                  "geometry")
colnames(merged_df)
```
```{r echo=FALSE, include=TRUE, message=FALSE, fig.height = 6, fig.width = 9}
### Explore relationship between income and every major percentage ###

#Create a new dataframe and change column names. Remove last three columns
education_percentage_only <- merged_df[,1:(length(merged_df)-3)]
colnames(education_percentage_only) <- c("neighbourhoods" ,
"no_certificate" ,
"education" ,
"arts_&_com",
"humanities" ,
"social_&_law" ,
"business" ,
"physical_&_life" ,
"mathematics_&_it" ,
"architecture_engin" ,
"agriculture" ,
"health" ,
"transportation" ,
"other" ,
"median_income")
#Plot each major in terms of income (y) and neighbourhood participation in each major (x)
education_percentage_only %>%
  gather(-c(median_income, neighbourhoods), key = "var", value = "value") %>% 
  ggplot(aes(x = value, y = median_income)) +
    facet_wrap(~ var, scales = "fixed") +
    geom_point(shape=20, color="blue", size=1) +
    stat_smooth(method=lm, se=FALSE,  colour="red") +
    labs(title = "Major by Income", x = "Neighbourhood Distribution by Major (%)", 
       y = "Median Income")
```

```{r echo=FALSE, include=TRUE, message=FALSE, fig.height = 5, fig.width = 9}
### Business major seem to have a stiff line, lets zoom in to it ###
# Get highest 5 and lowest 5 income values
income <- education_percentage_only$median_income
h5th <- sort(income)[length(income)-4]
l5th <- sort(income)[5]
# Assign income labels to the neighbourhoods
education_percentage_only$range<-ifelse(income >= h5th,"top 5",
		ifelse(income <= l5th,"bottom 5","rest"
		))
# Plot business major by income and neighbourhood distribution
ggplot(education_percentage_only, aes(x=business, y=median_income, color=range)) +        geom_point() + 
    labs(title = "Business Major by Income", x = "Distribution by Major (%)", 
       y = "Median Income")
# Run linear regression model
linearMod <- lm(business ~ median_income, data=education_percentage_only)
summary(linearMod)
```


```{r echo=FALSE, include=TRUE, message=FALSE, fig.height = 4, fig.width = 9}
### Analizing the highest income neighbourhood ###
# Plot major percentage distribution in highest income neighbourhood
education_df_highest <- education_percentage_only %>%
  filter(median_income == max(median_income) )
data_plot_highest <- 
  education_df_highest %>% 
  pivot_longer(cols = "education":"transportation", names_to = "major")
# Make a bar chart
data_plot_highest %>% 
  ggplot(aes(x = major, y = value, fill = major)) +
  geom_col()+
  ylim(0,30)+
  scale_x_discrete(
        labels=c("Agri", "Arch", "Art", "Bus","Edu", "Health", "Hum","Math", "Phys","Social", "Tran"))+
  labs(title = "Highest Income Neighbourhood by Major", x = "Major", 
       y = "Distribution (%)")
```

```{r echo=FALSE, include=TRUE, message=FALSE, fig.height = 4, fig.width = 9}
### Analizing the lowest income neighbourhood ###
# Plot major percentage distribution in lowest income neighbourhood
education_df_highest <- education_percentage_only %>%
  filter(median_income == min(median_income) )
data_plot_highest <- 
  education_df_highest %>% 
  pivot_longer(cols = "education":"transportation", names_to = "major")
# Make a bar chart
data_plot_highest %>% 
  ggplot(aes(x = major, y = value, fill = major)) +
  geom_col()+
  ylim(0,30)+
  scale_x_discrete(
        labels=c("Agri", "Arch", "Art", "Bus","Edu", "Health", "Hum","Math", "Phys","Social", "Tran"))+
  labs(title = "Lowest Income Neighbourhood by Major", x = "Major", 
       y = "Distribution (%)")
```

```{r echo=FALSE, include=TRUE, message=FALSE, fig.height = 5, fig.width = 9, warning=FALSE}
#Plot Median Income
tmap_mode("plot")
tm_shape(sf_merged_df) +
  tm_polygons(col = "median_income",
              breaks = c(25000,50000,75000,100000,125000,150000,200000),
              #style = "quantile",
              legend.hist = TRUE,
              palette = "seq") +
  tm_layout(legend.outside = TRUE)

#Plot all majors without palette
tmap_mode("plot")
tm_shape(sf_merged_df) +
tm_scale_bar(width = 0.5)+
tm_layout(legend.show = TRUE, legend.position = c("right", "bottom"), title.size = 2, title.position = c("center","center")) +
  tm_polygons(c("no_certificate" ,
"education" ,
"arts_&_com",
"humanities" ,
"social_&_law" ,
"business" ,
"physical_&_life" ,
"mathematics_&_it" ,
"architecture_engin" ,
"agriculture" ,
"health" ,
"transportation")) +
  tm_facets(sync = TRUE, ncol = 4)

```
